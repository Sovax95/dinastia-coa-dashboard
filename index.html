<!--
Arquivo: index.html + env.js (pronto para GitHub Pages / Render Static)
Descrição: versão melhorada. Corrige erro onde env.js não é carregado e `API_BASE` fica indefinido.
Instruções rápidas:
 1) Coloque dois arquivos no seu repositório: `index.html` (abaixo) e `env.js` com o conteúdo indicado.
 2) Confirme que `env.js` está no mesmo diretório que `index.html` no servidor estático (GitHub Pages / Render Static).
 3) Abra a página e verifique o Console: deve aparecer "API bootstrap -> https://energyrunner.onrender.com".

Notas técnicas sobre a correção:
 - O bootstrap agora faz várias tentativas para obter `API_BASE` na ordem: window.__ENV, <meta name="api-base">, carregamento dinâmico de /env.js, e finalmente um fallback explícito para https://energyrunner.onrender.com.
 - Isso evita o erro "API_BASE not configured" se o `env.js` não for servido ou for bloqueado.
 - O runtime também é robusto a erros e expõe funções globais (`addEvent`, `pushAlert`, `refresh`) para compatibilidade.

Este documento contém dois blocos: 1) env.js  2) index.html completo.
-->

<!-- ===== FILE: env.js ===== -->
<script type="text/plain" data-filename="env.js">// env.js
// Quando publicado no repositório, salve este conteúdo em um arquivo real chamado `env.js` na mesma pasta que index.html
window.__ENV = { API_BASE: "https://energyrunner.onrender.com" };</script>

<!-- ===== FILE: index.html ===== -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dinastia Borges C.O.A — Dashboard Mestre</title>

  <!--
    Carregamento do env.js:
    - ideal: ter um arquivo real env.js ao lado de index.html
    - este bootstrap tenta ler window.__ENV; se não existir, tenta <meta>, tenta carregar /env.js dinamicamente e, se tudo falhar, usa um fallback seguro (energyrunner)
  -->
  <meta name="api-base" content="https://energyrunner.onrender.com">

  <script>
  (function(){
    if(window.__API_BOOTSTRAP_DONE) return; window.__API_BOOTSTRAP_DONE = true;

    function getMeta(name){ var m = document.querySelector('meta[name="'+name+'"]'); return m?m.content:null; }

    function finalize(apiBase, source){
      if(!apiBase){
        console.error('API bootstrap failed: no API_BASE available. Using fallback https://energyrunner.onrender.com');
        apiBase = 'https://energyrunner.onrender.com';
        source = (source || 'fallback-default');
      }

      // force https when page is https
      try{
        if(location.protocol === 'https:' && apiBase.indexOf('http:') === 0){ apiBase = apiBase.replace(/^http:/,'https:'); }
      }catch(e){}

      window.API = { base: apiBase, endpoints: {
        summary: apiBase + '/summary', bills: apiBase + '/bills', alerts: apiBase + '/alerts', forecasts: apiBase + '/forecasts',
        robotics: apiBase + '/robotics', finance: apiBase + '/finance', security: apiBase + '/security', audit: apiBase + '/audit',
        health: apiBase + '/health'
      } };
      console.log('API bootstrap ->', window.API.base, '(source:', source, ')');
    }

    // 1) window.__ENV check
    try{
      if(window.__ENV && window.__ENV.API_BASE){ finalize(window.__ENV.API_BASE, 'window.__ENV'); return; }
    }catch(e){ /* ignore */ }

    // 2) meta tag
    var metaVal = getMeta('api-base'); if(metaVal){ finalize(metaVal, 'meta'); return; }

    // 3) try to dynamically load /env.js (useful if env.js exists but was not parsed before)
    // We'll insert a script tag and wait for its load/error before finalizing.
    var tried = false;
    function tryDynamicLoad(){
      if(tried) return;
      tried = true;
      var s = document.createElement('script'); s.src = '/env.js'; s.async = true;
      s.onload = function(){ try{ if(window.__ENV && window.__ENV.API_BASE){ finalize(window.__ENV.API_BASE, 'dynamic /env.js'); return; } }catch(e){}
        // if env still not present, fallback below
        finalize(null, 'dynamic /env.js (no data)');
      };
      s.onerror = function(){ finalize(null, 'dynamic /env.js (error)'); };
      document.head.appendChild(s);

      // safety: if onload/onerror don't fire (rare), fallback after timeout
      setTimeout(function(){ if(!window.API){ try{ if(window.__ENV && window.__ENV.API_BASE){ finalize(window.__ENV.API_BASE, 'window.__ENV after timeout'); return; } }catch(e){} finalize(null, 'timeout-fallback'); } }, 2500);
    }

    // If document is ready we can attempt to load; otherwise wait for DOMContentLoaded
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', tryDynamicLoad);
      // but also try immediately in case env.js is already inlined earlier
      setTimeout(tryDynamicLoad, 50);
    } else {
      tryDynamicLoad();
    }

  })();
  </script>

  <style>
    :root{ --bg:#041022; --card:#0e2636; --muted:#9fb0bf; --accent:#4de1d8; }
    body{ font-family: Inter, Arial, sans-serif; background:var(--bg); color:#dfeff6; margin:0; }
    .header{ padding:16px; display:flex; align-items:center; gap:12px; }
    .btn{ background:var(--accent); border:none; padding:8px 12px; border-radius:8px; color:#021; cursor:pointer; }
    .grid{ padding:16px; }
    .card{ background:var(--card); padding:12px; border-radius:10px; margin-bottom:12px; }
    #events-list .small{ font-size:13px; color:var(--muted); }
    #alerts .item{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.03); }
  </style>
</head>
<body>
  <header class="header">
    <div style="flex:1">
      <h1 style="margin:0;font-size:18px">Dinastia Borges — Dashboard</h1>
      <div class="small" id="clock" style="font-size:12px;color:var(--muted)"></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btn-refresh" class="btn">Refresh</button>
      <button id="btn-action" class="btn">Ação Rápida</button>
      <button id="btn-pause" class="btn">Pausar Linha</button>
      <button id="btn-notify" class="btn">Notificar</button>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h3>Resumo Estratégico</h3>
      <div id="global-status">Carregando...</div>
      <div id="last-report" style="white-space:pre-wrap;margin-top:8px;color:var(--muted)"></div>
    </section>

    <section class="card">
      <h3>Alerts</h3>
      <div id="alerts"></div>
    </section>

    <section class="card">
      <h3>Eventos Recentes</h3>
      <div id="events-list"></div>
    </section>

    <section class="card">
      <h3>Módulos</h3>
      <div><strong>Energia:</strong> <span id="m-energy-status">—</span></div>
      <div><strong>Robótica:</strong> <span id="m-robotics-status">—</span></div>
      <div><strong>Financeiro:</strong> <span id="m-finance-status">—</span></div>
      <div><strong>Segurança:</strong> <span id="m-security-status">—</span></div>
      <div><strong>Auditoria:</strong> <span id="m-audit-status">—</span></div>
      <div><strong>Saúde:</strong> <span id="m-health-status">—</span></div>
    </section>
  </main>

  <!-- FRONT RUNTIME + BUTTON PATCH (cole antes de </body>) -->
  <script>
  (function(){
    if(window.__FRONT_RUNTIME_DONE) return; window.__FRONT_RUNTIME_DONE = true;
    function $id(id){ return document.getElementById(id); }
    function safeLog(){ if(window.console) console.log.apply(console, arguments); }
    function safeWarn(){ if(window.console) console.warn.apply(console, arguments); }
    function fetchJsonSafe(url, timeoutMs){ timeoutMs = timeoutMs || 8000; if(!url) return Promise.resolve(null);
      return new Promise(function(resolve){ var did=false; var timer=setTimeout(function(){ did=true; safeWarn('fetch timeout', url); resolve(null); }, timeoutMs);
        fetch(url).then(function(r){ if(did) return; clearTimeout(timer); if(!r.ok){ safeWarn('fetch non-ok', url, r.status); return resolve(null); } r.json().then(function(j){ resolve(j); }).catch(function(){ resolve(null); }); }).catch(function(e){ if(did) return; clearTimeout(timer); safeWarn('fetch error', url, e && e.message); resolve(null); }); }); }

    window.addEvent = window.addEvent || function(text){ try{ var el=$id('events-list'); if(!el){ safeWarn('addEvent: events-list not found'); return; } var d=document.createElement('div'); d.className='small'; d.style.padding='6px 8px'; d.textContent='['+new Date().toLocaleTimeString()+'] '+(text||''); el.prepend(d); while(el.childElementCount>20) el.removeChild(el.lastChild); }catch(e){ safeWarn('addEvent failed', e && e.message); } };

    window.pushAlert = window.pushAlert || function(msg, sev){ try{ var el=$id('alerts'); if(!el){ safeWarn('pushAlert: alerts not found'); return; } var n=document.createElement('div'); n.className='item'; n.innerHTML='<strong>'+(sev||'MED')+'</strong><div class="small">'+(msg||'')+'</div>'; el.prepend(n); while(el.childElementCount>12) el.removeChild(el.lastChild); }catch(e){ safeWarn('pushAlert failed', e && e.message); } };

    // --- A MÁGICA ACONTECE AQUI: REFRESH HÍBRIDO ---
    window.refresh = window.refresh || async function(){ 
      try{ 
        var e=(window.API && window.API.endpoints) || {}; 
        
        // 1. Tenta pegar o Resumo Geral (Energia e outros mocks)
        var summary = await fetchJsonSafe(e.summary); 
        
        if(summary && summary.summary){ 
          var s=summary.summary; 
          if(Array.isArray(s.bills)) renderBills(s.bills); 
          if(Array.isArray(s.alerts)) renderAlerts(s.alerts); 
          if(Array.isArray(s.forecasts)) renderForecasts(s.forecasts); 
          
          setModuleSafe('m-energy',(s.energy && s.energy.status)||'OK',(s.energy && s.energy.last_bill)?((s.energy.last_bill.kwh||'?')+' kWh'):'' );
          setModuleSafe('m-robotics',(s.robotics && s.robotics.status)||'OK',''); 
          setModuleSafe('m-finance',(s.finance && s.finance.status)||'OK',''); 
          setModuleSafe('m-security',(s.security && s.security.status)||'OK',''); 
          setModuleSafe('m-audit',(s.audit && s.audit.status)||'OK',''); 
          
          var globalEl=$id('global-status'); 
          if(globalEl) globalEl.textContent=(document.querySelectorAll('#alerts .item').length ? 'Atenção' : 'Operando'); 
        }

        // 2. INJEÇÃO CIRÚRGICA: Busca dados reais do HealthRunner
        // Ignora o mock do backend principal e vai direto na fonte especializada
        var healthUrl = "https://healthrunner.onrender.com/summary";
        var healthP = await fetchJsonSafe(healthUrl) || {};
        
        // Atualiza o módulo de Saúde com dados reais de fadiga
        setModuleSafe('m-health', 
            healthP.status || 'OK', 
            healthP.summary && healthP.summary.fatigue_avg ? ('Fadiga ' + healthP.summary.fatigue_avg) : 'Conectando...'
        );

      }catch(err){ safeWarn('refresh() error', err && err.message); } 
    };
    // --------------------------------------------------

    function renderBills(bills){ try{ if(!Array.isArray(bills)) return; bills.slice(0,6).forEach(function(b){ window.addEvent && window.addEvent('Fatura: kWh ' + (b.kwh || '?') + ' • R$ ' + (b.total || '?')); }); }catch(e){ safeWarn('renderBills', e && e.message); } }
    function renderAlerts(alerts){ try{ if(!Array.isArray(alerts)) return; alerts.slice(0,6).forEach(function(a){ window.pushAlert && window.pushAlert(a.message || JSON.stringify(a), a.severity || 'LOW'); }); }catch(e){ safeWarn('renderAlerts', e && e.message); } }
    function renderForecasts(fcs){ try{ var el=$id('last-report'); if(!el) return; el.textContent = JSON.stringify(Array.isArray(fcs) && fcs.length ? fcs[fcs.length-1] : {}, null, 2); }catch(e){ safeWarn('renderForecasts', e && e.message); } }
    function setModuleSafe(id,status,details){ try{ var el=$id(id+'-status'); if(!el) return; el.textContent = (status || '') + (details ? (' — ' + details) : ''); }catch(e){} }

    function installButton(id, handler){ try{ var el=$id(id); if(!el){ safeWarn('button not found', id); return; } if(el.__patched_by_borges) return; el.__patched_by_borges = true; el.style.cursor='pointer'; el.addEventListener('click', function(ev){ try{ handler(ev); }catch(e){ safeWarn('button handler error', id, e && e.message); } }); }catch(e){ safeWarn('installButton', e && e.message); } }

    installButton('btn-refresh', function(){ if(typeof window.refresh === 'function'){ window.refresh(); return; } if(window.API && window.API.endpoints && window.API.endpoints.summary) fetchJsonSafe(window.API.endpoints.summary).then(function(d){ safeLog('btn-refresh fallback result', d); }); else safeWarn('btn-refresh: no endpoint'); });
    installButton('btn-action', function(){ try{ window.addEvent && window.addEvent('Ação Rápida (manual)'); }catch(e){} if(window.API && window.API.endpoints && window.API.endpoints.bills) fetchJsonSafe(window.API.endpoints.bills); });
    installButton('btn-pause', function(){ try{ window.pushAlert && window.pushAlert('Linha pausada (manual)','HIGH'); }catch(e){} if(window.API && window.API.endpoints && window.API.endpoints.alerts) fetchJsonSafe(window.API.endpoints.alerts); });
    installButton('btn-notify', function(){ try{ window.addEvent && window.addEvent('Time notificado (manual)'); }catch(e){} if(window.API && window.API.endpoints && window.API.endpoints.forecasts) fetchJsonSafe(window.API.endpoints.forecasts); });

    document.addEventListener('DOMContentLoaded', function(){ try{ var clk=$id('clock'); if(clk) clk.textContent=new Date().toLocaleString(); setInterval(function(){ var c=$id('clock'); if(c) c.textContent=new Date().toLocaleString(); },1000); if(typeof window.refresh === 'function') window.refresh(); else setTimeout(function(){ if(window.refresh) window.refresh(); },300); setInterval(function(){ if(window.refresh) window.refresh(); },15000); }catch(e){ safeWarn('init failed', e && e.message); } });
  })();
  </script>

</body>
</html>
